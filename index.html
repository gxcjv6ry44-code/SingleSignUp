<script>
  /***********************
   * CONFIG
   ***********************/
  const MAKE_WEBHOOK_URL = "https://hook.us2.make.com/p051xaxanggdra1jycntxjduaq6l9nsa";
  const SEND_TO_MAKE = true; // set false to test locally without sending

  const STAKE_WARDS = {
    BenLomond: ["Ward 1", "Ward 2", "Ward 3"],
    PlainCity: ["North", "Central", "South"],
    FarrWest: ["A", "B", "C", "D"],
    FarrWestPoplar: ["Poplar 1", "Poplar 2"],
    MountLewis: ["Red", "Blue", "Green"],
    MoundFort: ["East", "West"],
    OgdenWest: ["1", "2", "3", "4"],
    EastRidge: ["Hills", "Valley", "Lake"],
    NorthGate: ["Alpha", "Beta"],
    SouthPoint: ["1", "2"]
  };

  // ---- Element lookups ----
  const form = document.getElementById("apptForm");
  const out = document.getElementById("output");
  const successMsg = document.getElementById("successMsg");

  const fullNameEl = document.getElementById("fullName");
  const phoneEl = document.getElementById("phone");
  const emailEl = document.getElementById("email");
  const stakeEl = document.getElementById("stake");
  const wardEl = document.getElementById("ward");
  const dateEl = document.getElementById("date");
  const dateHint = document.getElementById("dateHint");
  const resetBtn = document.getElementById("resetBtn");
  const orchardBtn = document.getElementById("orchardBtn");
  const smsOptInEl = document.getElementById("smsOptIn");

  // If this fires, you're viewing a different/cached page or the DOM is broken.
  if (!form || !stakeEl || !wardEl || !dateEl) {
    const msg = "ERROR: Form did not initialize (missing expected elements). Are you viewing the latest page/version?";
    console.error(msg, { form, stakeEl, wardEl, dateEl });
    if (out) out.textContent = msg;
  }

  function setError(id, msg) {
    const el = document.getElementById(id);
    if (el) el.textContent = msg || "";
  }

  function clearErrors() {
    ["errName","errPhone","errEmail","errStake","errWard","errDate","errTime","errSubmit"]
      .forEach(id => setError(id, ""));
    if (successMsg) successMsg.textContent = "";
  }

  // Populate Stake dropdown
  // (Only once; but even if it runs twice, it won't break validation.)
  Object.keys(STAKE_WARDS).forEach(s => {
    const opt = document.createElement("option");
    opt.value = s;
    opt.textContent = s;
    stakeEl.appendChild(opt);
  });

  // Stake -> Ward
  stakeEl.addEventListener("change", () => {
    wardEl.innerHTML = "";
    wardEl.value = ""; // ensure reset

    if (!stakeEl.value) {
      wardEl.disabled = true;
      wardEl.innerHTML = "<option value=''>Choose a stake first…</option>";
      return;
    }

    wardEl.disabled = false;
    wardEl.innerHTML = "<option value=''>Select a ward…</option>";
    (STAKE_WARDS[stakeEl.value] || []).forEach(w => {
      const opt = document.createElement("option");
      opt.value = w;
      opt.textContent = w;
      wardEl.appendChild(opt);
    });
  });

  orchardBtn.addEventListener("click", () => {
    window.location.href = "https://northogdenorchard.net";
  });

  function normalizePhone(raw) {
    const digits = (raw || "").replace(/\D/g, "");
    if (digits.length === 10) return digits;
    if (digits.length === 11 && digits.startsWith("1")) return digits.slice(1);
    return null;
  }

  function getSelectedTime() {
    const checked = document.querySelector('input[name="timeSlot"]:checked');
    return checked ? checked.value : null;
  }

  function parseLocalDate(yyyyMmDd) {
    if (!yyyyMmDd) return null;
    const [y,m,d] = yyyyMmDd.split("-").map(Number);
    return new Date(y, m - 1, d);
  }

  function isWednesday(d) { return d && d.getDay() === 3; }

  function toYyyyMmDd(d) {
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${dd}`;
  }

  function nextWednesday(fromDate) {
    const d = new Date(fromDate.getFullYear(), fromDate.getMonth(), fromDate.getDate());
    const diff = (3 - d.getDay() + 7) % 7;
    d.setDate(d.getDate() + diff);
    return d;
  }

  function applyYouthNightRulesIfNeeded() {
    const timeSlot = getSelectedTime();
    const isYouth = timeSlot === "Youth Night";

    dateHint.textContent = isYouth
      ? "Youth Night is Wednesdays only (6:30–8:00)."
      : "Choose any future date.";

    if (!isYouth) return;

    const current = parseLocalDate(dateEl.value);
    const base = current || new Date();
    const nextWed = nextWednesday(base);

    if (!current || !isWednesday(current)) {
      dateEl.value = toYyyyMmDd(nextWed);
    }
  }

  document.querySelectorAll('input[name="timeSlot"]').forEach(r => {
    r.addEventListener("change", applyYouthNightRulesIfNeeded);
  });

  dateEl.addEventListener("change", () => {
    if (getSelectedTime() === "Youth Night") {
      const d = parseLocalDate(dateEl.value);
      if (d && !isWednesday(d)) {
        dateEl.value = toYyyyMmDd(nextWednesday(d));
      }
    }
  });

  // no past dates
  dateEl.min = toYyyyMmDd(new Date());

  // ---- Submit ----
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    clearErrors();

    console.log("Submit fired"); // <-- you will see this every submit

    const fullName = fullNameEl.value.trim();
    const phoneRaw = phoneEl.value.trim();
    const email = emailEl.value.trim().toLowerCase();

    const stake = stakeEl.value;
    const ward = wardEl.value;
    const dateStr = dateEl.value;

    const timeSlot = getSelectedTime();
    let ok = true;

    if (!fullName) { setError("errName", "Name is required."); ok = false; }

    const phone = normalizePhone(phoneRaw);
    if (!phone) { setError("errPhone", "Enter a valid US phone number (10 digits)."); ok = false; }

    if (!email) { setError("errEmail", "Email is required."); ok = false; }
    else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { setError("errEmail", "Enter a valid email address."); ok = false; }

    if (!stake) { setError("errStake", "Please select a stake."); ok = false; }
    if (!ward) { setError("errWard", "Please select a ward."); ok = false; }
    if (!dateStr) { setError("errDate", "Please choose a date."); ok = false; }

    if (!timeSlot) { setError("errTime", "Please select a time slot."); ok = false; }

    if (timeSlot === "Youth Night" && dateStr) {
      const d = parseLocalDate(dateStr);
      if (!isWednesday(d)) {
        setError("errDate", "Youth Night is Wednesdays only. Please choose a Wednesday.");
        ok = false;
      }
    }

    if (!ok) {
      console.warn("Validation failed; not sending to Make.");
      return;
    }

    const timeRange =
      timeSlot === "AM Volunteer" ? "8:00–10:00" :
      timeSlot === "PM Volunteer" ? "5:00–7:00" :
      "6:30–8:00";

    const smsOptIn = smsOptInEl ? smsOptInEl.checked : false;

    const payload = {
      fullName,
      phone,
      email,
      stake,
      ward,
      date: dateStr,
      timeSlot,
      timeRange,
      smsOptIn
    };

    out.textContent = JSON.stringify(payload, null, 2);

    const canSend = SEND_TO_MAKE && MAKE_WEBHOOK_URL.trim().length > 0;
    if (!canSend) {
      successMsg.textContent = "Submitted ✓ (see JSON below)";
      console.warn("SEND_TO_MAKE disabled or webhook URL missing; not sending.");
      return;
    }

    console.log("About to POST to Make:", MAKE_WEBHOOK_URL.trim(), payload);

    try {
      const resp = await fetch(MAKE_WEBHOOK_URL.trim(), {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      console.log("Make response status:", resp.status);

      if (!resp.ok) throw new Error(`Make error ${resp.status}`);
      successMsg.textContent = "Submitted ✓ (saved to Google Sheet)";
    } catch (err) {
      console.error(err);
      setError("errSubmit", "Send to Make failed. Check webhook URL and Make \"Run once\".");
    }
  });

  resetBtn.addEventListener("click", () => {
    form.reset();
    clearErrors();
    out.textContent = "{}";
    wardEl.disabled = true;
    wardEl.innerHTML = "<option value=''>Choose a stake first…</option>";
    dateHint.textContent = "Choose any future date.";
  });
</script>
